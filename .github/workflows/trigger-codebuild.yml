name: Trigger AWS CodeBuild

on:
  push:
    branches:
      - main
  pull_request:
    branches: 
      - main
    types: [opened, synchronize, reopened]

jobs:
  trigger-codebuild:
    name: Trigger CodeBuild
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2
      
      - name: Get branch name
        id: branch-name
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "branch=${{ github.head_ref }}" >> $GITHUB_OUTPUT
          else
            echo "branch=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT
          fi
      
      - name: Trigger CodeBuild
        id: codebuild
        run: |
          BUILD_ID=$(aws codebuild start-build \
            --project-name backend-build-project \
            --source-version ${{ steps.branch-name.outputs.branch }} \
            --query 'build.id' \
            --output text)
          echo "build-id=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "âœ… CodeBuild íŠ¸ë¦¬ê±° ì„±ê³µ: $BUILD_ID"
      
      - name: Wait for CodeBuild completion
        id: wait-build
        run: |
          BUILD_ID="${{ steps.codebuild.outputs.build-id }}"
          echo "â³ CodeBuild ë¹Œë“œ ì§„í–‰ ì¤‘..."
          echo "ğŸ“Š Build ID: $BUILD_ID"
          echo "ğŸ”— AWS Console: https://ap-northeast-2.console.aws.amazon.com/codesuite/codebuild/$BUILD_ID/log?region=ap-northeast-2"
          echo ""
          
          # ë¹Œë“œ ì™„ë£Œê¹Œì§€ ëŒ€ê¸° (ìµœëŒ€ 15ë¶„)
          MAX_WAIT=900  # 15ë¶„
          ELAPSED=0
          SLEEP_TIME=10
          
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            # ë¹Œë“œ ìƒíƒœ í™•ì¸
            BUILD_STATUS=$(aws codebuild batch-get-builds \
              --ids "$BUILD_ID" \
              --query 'builds[0].buildStatus' \
              --output text)
            
            CURRENT_PHASE=$(aws codebuild batch-get-builds \
              --ids "$BUILD_ID" \
              --query 'builds[0].currentPhase' \
              --output text)
            
            echo "â±ï¸  $(date +%H:%M:%S) | Status: $BUILD_STATUS | Phase: $CURRENT_PHASE"
            
            # ë¹Œë“œ ì™„ë£Œ ìƒíƒœ í™•ì¸
            case "$BUILD_STATUS" in
              "SUCCEEDED")
                echo ""
                echo "âœ… CodeBuild ë¹Œë“œ ì„±ê³µ!"
                echo "build-status=SUCCEEDED" >> $GITHUB_OUTPUT
                exit 0
                ;;
              "FAILED"|"FAULT"|"TIMED_OUT"|"STOPPED")
                echo ""
                echo "âŒ CodeBuild ë¹Œë“œ ì‹¤íŒ¨: $BUILD_STATUS"
                echo "build-status=$BUILD_STATUS" >> $GITHUB_OUTPUT
                exit 1
                ;;
              "IN_PROGRESS")
                # ê³„ì† ëŒ€ê¸°
                sleep $SLEEP_TIME
                ELAPSED=$((ELAPSED + SLEEP_TIME))
                ;;
              *)
                echo "âš ï¸  ì•Œ ìˆ˜ ì—†ëŠ” ìƒíƒœ: $BUILD_STATUS"
                sleep $SLEEP_TIME
                ELAPSED=$((ELAPSED + SLEEP_TIME))
                ;;
            esac
          done
          
          # íƒ€ì„ì•„ì›ƒ
          echo ""
          echo "â° CodeBuild ëŒ€ê¸° ì‹œê°„ ì´ˆê³¼ (15ë¶„)"
          echo "ğŸ”— AWS Consoleì—ì„œ í™•ì¸: https://ap-northeast-2.console.aws.amazon.com/codesuite/codebuild/$BUILD_ID/log?region=ap-northeast-2"
          echo "build-status=TIMEOUT" >> $GITHUB_OUTPUT
          exit 1
      
      - name: Build Summary
        if: always()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š CodeBuild ë¹Œë“œ ê²°ê³¼ ìš”ì•½"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Build ID: ${{ steps.codebuild.outputs.build-id }}"
          echo "Status: ${{ steps.wait-build.outputs.build-status }}"
          echo "Branch: ${{ steps.branch-name.outputs.branch }}"
          echo ""
          
          if [[ "${{ steps.wait-build.outputs.build-status }}" == "SUCCEEDED" ]]; then
            echo "âœ… ë¹Œë“œ ì„±ê³µ!"
            echo "ğŸš€ ArgoCDê°€ ìë™ìœ¼ë¡œ EKSì— ë°°í¬í•©ë‹ˆë‹¤."
            echo "â±ï¸  ì•½ 3-5ë¶„ í›„ ë°°í¬ ì™„ë£Œ ì˜ˆìƒ"
          else
            echo "âŒ ë¹Œë“œ ì‹¤íŒ¨!"
            echo "ğŸ”— ë¡œê·¸ í™•ì¸: https://ap-northeast-2.console.aws.amazon.com/codesuite/codebuild/${{ steps.codebuild.outputs.build-id }}/log?region=ap-northeast-2"
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

